<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Karishma AI: Future Edition</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéÄ</text></svg>">

<style>
    /* --- VARIABLES --- */
    :root { 
        --sky-day: linear-gradient(180deg, #2980b9, #6dd5fa, #ffffff);
        --sky-night: linear-gradient(180deg, #000000, #1a2a6c, #b21f1f);
        --robot-skin: #f0f0f0;
        --robot-accent: #ff00cc; /* Neon Pink */
        --robot-glow: 0 0 10px #ff00cc;
        --chat-bg: rgba(255, 255, 255, 0.95);
    }
    
    * { box-sizing: border-box; }
    body { margin: 0; padding: 0; width: 100vw; height: 100vh; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: row; }

    /* --- LAYOUT --- */
    #visual-area { flex: 1; position: relative; overflow: hidden; background: var(--sky-day); transition: background 2s ease; z-index: 1; }
    #visual-area.night { background: var(--sky-night); }
    #chat-area { width: 380px; background: var(--chat-bg); backdrop-filter: blur(10px); display: flex; flex-direction: column; border-left: 1px solid #aaa; z-index: 100; box-shadow: -5px 0 30px rgba(0,0,0,0.3); }
    @media (max-width: 800px) { body { flex-direction: column; } #visual-area { height: 60%; flex: none; } #chat-area { width: 100%; flex: 1; border-left: none; border-top: 1px solid #ddd; } }

    /* --- REAL-TIME SKY --- */
    .celestial-body {
        position: absolute; width: 60px; height: 60px; border-radius: 50%;
        left: 50%; top: 100%; /* Hidden by default */
        transition: all 1s linear; pointer-events: none;
    }
    .sun { background: radial-gradient(circle, #fff700, #ff8c00); box-shadow: 0 0 60px #ff8c00; z-index: 2; }
    .moon { background: radial-gradient(circle, #f6f6f6, #cfcfcf); box-shadow: 0 0 40px #ffffff; z-index: 2; }
    
    .cloud {
        position: absolute; background: rgba(255,255,255,0.8); border-radius: 50px;
        animation: floatCloud 60s linear infinite; z-index: 3; opacity: 0.9;
    }
    .c1 { width: 120px; height: 40px; top: 15%; left: -20%; }
    .c2 { width: 80px; height: 30px; top: 25%; left: -10%; animation-duration: 80s; }
    @keyframes floatCloud { 0% { left: -20%; } 100% { left: 120%; } }

    /* --- WEATHER DISPLAY --- */
    #weather-widget {
        position: absolute; top: 15px; left: 15px; 
        background: rgba(0,0,0,0.6); color: white; padding: 8px 15px; border-radius: 20px;
        font-size: 12px; display: flex; align-items: center; gap: 8px; z-index: 50;
        border: 1px solid rgba(255,255,255,0.2); backdrop-filter: blur(5px);
    }

    /* --- LANDSCAPE --- */
    .ground { position: absolute; bottom: 0; width: 100%; height: 25%; background: linear-gradient(to bottom, #76b852, #4caf50); z-index: 4; clip-path: polygon(0 20%, 100% 0, 100% 100%, 0% 100%); }
    .road {
        position: absolute; bottom: 0; left: 50%; transform: translateX(-50%);
        width: 150px; height: 25%; background: #555;
        clip-path: polygon(20% 0, 80% 0, 100% 100%, 0% 100%);
        z-index: 5;
    }
    .road-line {
        position: absolute; top: 0; left: 50%; transform: translateX(-50%);
        width: 4px; height: 100%; border-left: 4px dashed white;
    }
    .pond {
        position: absolute; bottom: 5%; right: 5%; width: 180px; height: 60px;
        background: rgba(0, 150, 255, 0.6); border-radius: 50%;
        box-shadow: inset 0 0 20px rgba(0,0,50,0.2); z-index: 5;
        border: 2px solid rgba(255,255,255,0.3); overflow: hidden;
    }
    .pond::after {
        content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: linear-gradient(45deg, transparent 40%, rgba(255,255,255,0.4) 50%, transparent 60%);
        opacity: 0.5;
    }

    /* --- REALISTIC TREES --- */
    .tree { position: absolute; bottom: 18%; z-index: 6; cursor: pointer; transition: transform 0.2s; }
    .tree:hover { transform: scale(1.05); }
    .tree-trunk { width: 12px; height: 80px; background: #3e2723; margin: 0 auto; border-radius: 2px; }
    .tree-crown { 
        position: absolute; bottom: 60px; left: 50%; transform: translateX(-50%);
        width: 0; height: 0; 
    }
    .leaf-cluster {
        position: absolute; background: #2d6a4f; border-radius: 50%;
        box-shadow: inset -2px -2px 0 rgba(0,0,0,0.2);
    }
    /* Procedural leaves */
    .l1 { width: 60px; height: 60px; top: 0; left: -30px; background: #40916c; }
    .l2 { width: 50px; height: 50px; top: -30px; left: -25px; background: #52b788; }
    .l3 { width: 55px; height: 55px; top: -15px; left: 0px; background: #2d6a4f; }

    /* --- HOUSE --- */
    .house-group { position: absolute; bottom: 18%; left: 10%; z-index: 6; cursor: pointer; }
    .house-body { width: 120px; height: 90px; background: #fdfcdc; border: 2px solid #555; position: relative; box-shadow: 5px 5px 15px rgba(0,0,0,0.3); }
    .house-roof { 
        position: absolute; top: -50px; left: -10px; 
        border-bottom: 50px solid #d62828; border-left: 70px solid transparent; border-right: 70px solid transparent; 
        filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.2));
    }
    .house-door { width: 30px; height: 50px; background: #4a3b32; position: absolute; bottom: 0; left: 45px; border-radius: 20px 20px 0 0; }
    .house-window { width: 30px; height: 30px; background: #a8dadc; border: 2px solid #333; position: absolute; top: 20px; right: 10px; border-radius: 50%; }

    /* --- FUTURISTIC ROBOT (Anime Style) --- */
    .robot-wrapper {
        position: absolute; bottom: 15%; left: 50%; transform: translateX(-50%);
        z-index: 20; display: flex; flex-direction: column; align-items: center;
        filter: drop-shadow(0 0 15px rgba(255, 0, 204, 0.4));
        transition: transform 0.3s;
    }
    .robot-wrapper:active { transform: translateX(-50%) scale(0.95); }

    .r-head {
        width: 80px; height: 90px; background: #fff;
        border-radius: 40px 40px 30px 30px; border: 2px solid #ddd;
        position: relative; z-index: 2; overflow: hidden;
        box-shadow: inset -5px -5px 10px rgba(0,0,0,0.1);
    }
    /* Headphones */
    .r-ear {
        width: 20px; height: 40px; background: var(--robot-accent);
        position: absolute; top: 25px; border-radius: 5px;
        box-shadow: 0 0 10px var(--robot-accent);
    }
    .ear-l { left: -15px; } .ear-r { right: -15px; }
    
    .r-face {
        position: absolute; top: 35px; left: 10px; width: 60px; height: 40px;
        display: flex; justify-content: space-between; align-items: center; padding: 0 5px;
    }
    .r-eye {
        width: 18px; height: 24px; background: #222; border-radius: 50%;
        position: relative; animation: blink 4s infinite;
    }
    .r-eye::after { content:''; position:absolute; top:4px; right:4px; width:6px; height:6px; background:white; border-radius:50%; }
    .r-blush { width: 10px; height: 6px; background: #ffaaaa; border-radius: 50%; position: absolute; top: 30px; opacity: 0.6; }
    .blush-l { left: 5px; } .blush-r { right: 5px; }

    .r-body {
        width: 50px; height: 60px; background: #fff;
        margin-top: -10px; border-radius: 15px; border: 2px solid #ddd;
        position: relative; z-index: 1;
        display: flex; justify-content: center; align-items: center;
    }
    .r-core { width: 20px; height: 20px; background: var(--robot-accent); border-radius: 50%; box-shadow: var(--robot-glow); animation: heartbeat 2s infinite; }

    .r-limbs { position: absolute; width: 100%; top: 10px; }
    .r-arm {
        width: 12px; height: 50px; background: #fff; border: 2px solid #ddd;
        border-radius: 10px; position: absolute; top: 30px; transform-origin: top center;
    }
    .arm-l { left: -15px; transform: rotate(15deg); }
    .arm-r { right: -15px; transform: rotate(-15deg); }
    
    .r-legs { position: absolute; bottom: -35px; width: 100%; display: flex; justify-content: center; gap: 10px; }
    .r-leg { width: 14px; height: 40px; background: #333; border-radius: 0 0 10px 10px; }

    /* Animations */
    @keyframes blink { 0%, 48%, 52%, 100% { height: 24px; } 50% { height: 2px; } }
    @keyframes heartbeat { 0%, 100% { transform: scale(1); opacity: 0.8; } 50% { transform: scale(1.1); opacity: 1; } }
    @keyframes flyBird { from { left: -50px; } to { left: 110%; } }
    
    .bird {
        position: absolute; width: 10px; height: 5px; border-bottom: 2px solid #333; border-left: 2px solid #333;
        transform: rotate(-45deg); animation: flyBird 15s linear infinite; z-index: 10;
    }

    /* --- CHAT --- */
    .chat-history { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
    .msg { padding: 12px 16px; border-radius: 18px; font-size: 14px; max-width: 85%; animation: pop 0.3s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .u-msg { align-self: flex-end; background: var(--robot-accent); color: white; border-bottom-right-radius: 2px; }
    .b-msg { align-self: flex-start; background: white; border: 1px solid #ddd; border-bottom-left-radius: 2px; }
    
    /* MODAL */
    #key-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; display: flex; justify-content: center; align-items: center; }
    .modal-box { background: white; padding: 30px; border-radius: 20px; text-align: center; width: 90%; max-width: 400px; border: 3px solid var(--robot-accent); }
    .key-input { width: 100%; padding: 12px; margin: 15px 0; border: 1px solid #ccc; border-radius: 8px; }
    .save-btn { background: var(--robot-accent); color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-weight: bold; }

</style>
</head>
<body>

<div id="key-modal" style="display:none;">
    <div class="modal-box">
        <h2>üéÄ Wake Up Karishma</h2>
        <p>Enter your <strong>Gemini API Key</strong> to start.</p>
        <input type="password" id="apiKeyInput" class="key-input" placeholder="Paste AIza... key">
        <button class="save-btn" onclick="saveKey()">Connect</button>
        <p style="font-size:12px; margin-top:10px;"><a href="https://aistudio.google.com/app/apikey" target="_blank">Get Free Key</a></p>
    </div>
</div>

<div id="visual-area">
    <div id="weather-widget">üìç Detecting...</div>
    
    <div id="sun" class="celestial-body sun"></div>
    <div id="moon" class="celestial-body moon"></div>
    <div class="cloud c1"></div>
    <div class="cloud c2"></div>
    
    <div class="bird" style="top:20%; animation-delay:0s"></div>
    <div class="bird" style="top:30%; animation-delay:5s"></div>

    <div class="ground"></div>
    <div class="road"><div class="road-line"></div></div>
    <div class="pond"></div>

    <div class="tree" style="left:5%" onclick="interact('tree')">
        <div class="tree-crown"><div class="leaf-cluster l1"></div><div class="leaf-cluster l2"></div><div class="leaf-cluster l3"></div></div>
        <div class="tree-trunk"></div>
    </div>
    <div class="tree" style="right:8%" onclick="interact('tree')">
        <div class="tree-crown"><div class="leaf-cluster l1"></div><div class="leaf-cluster l2"></div><div class="leaf-cluster l3"></div></div>
        <div class="tree-trunk"></div>
    </div>

    <div class="house-group" onclick="interact('house')">
        <div class="house-roof"></div>
        <div class="house-body"><div class="house-window"></div><div class="house-door"></div></div>
    </div>

    <div class="robot-wrapper" id="karishma">
        <div class="r-head" onclick="interact('head')">
            <div class="r-ear ear-l"></div><div class="r-ear ear-r"></div>
            <div class="r-face">
                <div class="r-eye"></div><div class="r-eye"></div>
                <div class="r-blush blush-l"></div><div class="r-blush blush-r"></div>
            </div>
        </div>
        <div class="r-body" onclick="interact('tummy')">
            <div class="r-core"></div>
            <div class="r-limbs">
                <div class="r-arm arm-l" onclick="interact('hand')"></div>
                <div class="r-arm arm-r" onclick="interact('hand')"></div>
            </div>
            <div class="r-legs"><div class="r-leg"></div><div class="r-leg"></div></div>
        </div>
    </div>
</div>

<div id="chat-area">
    <div class="chat-header" style="padding:15px; border-bottom:1px solid #ddd; font-weight:bold; display:flex; justify-content:space-between;">
        <span>Karishma AI</span>
        <span id="status" style="font-size:11px; background:#eee; padding:3px 8px; border-radius:10px; cursor:pointer;" onclick="clearKey()">‚óè Change Key</span>
    </div>
    <div class="chat-history" id="chat"></div>
    <div style="padding:15px; border-top:1px solid #ddd; display:flex; gap:10px;">
        <input id="inp" style="flex:1; padding:10px; border-radius:20px; border:1px solid #ddd;" placeholder="Type here..." onkeypress="if(event.key==='Enter')send()">
        <button onclick="send()" style="background:var(--robot-accent); color:white; border:none; width:40px; height:40px; border-radius:50%; cursor:pointer;">‚û§</button>
    </div>
</div>

<script>
    // --- 1. API LOGIC (LOCKED & PRESERVED) ---
    let API_KEY = localStorage.getItem("gemini_key_auto_detect"); 
    let SELECTED_MODEL = ""; 
    const SYSTEM_PROMPT = "You are Karishma AI. Creator: Abhik Dutta. You are a futuristic, cute anime-style robot girl living in Assam. Keep replies short (max 20 words), sassy, and cute. Use emojis.";
    let history = [];

    // --- 2. STARTUP & WORLD LOGIC ---
    window.onload = async () => {
        if (!API_KEY) {
            document.getElementById("key-modal").style.display = "flex";
        } else {
            addBot("System Online! Calibrating visual sensors... üéÄ");
            await autoDetectModel();
        }
        updateSky(); // Run sun/moon logic
        fetchWeather(); // Get weather
        setInterval(updateSky, 60000); // Update sky every minute
    };

    // --- REAL-TIME SKY LOGIC ---
    function updateSky() {
        const now = new Date();
        const hour = now.getHours();
        const visual = document.getElementById("visual-area");
        const sun = document.getElementById("sun");
        const moon = document.getElementById("moon");

        // Simple Day/Night Toggle
        if (hour >= 6 && hour < 18) {
            visual.classList.remove("night");
            // Move Sun: Map 6am-6pm to 0%-100% arc
            const percent = (hour - 6) / 12 * 100; 
            sun.style.top = `${20 + Math.abs(percent - 50)}%`; // Arc motion
            sun.style.left = `${percent}%`;
            moon.style.top = "120%"; // Hide moon
        } else {
            visual.classList.add("night");
            // Move Moon: Map 6pm-6am
            let nightHour = hour >= 18 ? hour - 18 : hour + 6;
            const percent = nightHour / 12 * 100;
            moon.style.top = `${20 + Math.abs(percent - 50)}%`;
            moon.style.left = `${percent}%`;
            sun.style.top = "120%"; // Hide sun
        }
    }

    // --- WEATHER API (Open-Meteo) ---
    async function fetchWeather() {
        const widget = document.getElementById("weather-widget");
        try {
            // Default to Silchar, Assam (Lat: 24.83, Lon: 92.77)
            const lat = 24.83, lon = 92.77;
            const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`);
            const data = await res.json();
            const temp = data.current_weather.temperature;
            const code = data.current_weather.weathercode;
            
            let condition = "Sunny";
            if(code > 3) condition = "Cloudy";
            if(code > 50) condition = "Rainy üåßÔ∏è";
            
            widget.innerHTML = `üìç Silchar: ${temp}¬∞C ${condition}`;
            
            // Add Rain Effect if rainy code
            if(code > 50) visual.classList.add("rainy"); 

        } catch(e) {
            widget.innerText = "üìç Weather Offline";
        }
    }

    // --- API FUNCTIONS (LOCKED) ---
    function saveKey() {
        const input = document.getElementById("apiKeyInput").value.trim();
        if (input.startsWith("AIza")) {
            localStorage.setItem("gemini_key_auto_detect", input);
            API_KEY = input;
            document.getElementById("key-modal").style.display = "none";
            addBot("Key Saved! Initializing... ‚ú®");
            autoDetectModel();
        } else { alert("Invalid Key! Must start with 'AIza'"); }
    }

    async function autoDetectModel() {
        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${API_KEY}`);
            const data = await res.json();
            if(!response.ok) throw new Error("Key Error");
            const validModels = data.models.filter(m => m.supportedGenerationMethods.includes("generateContent"));
            const best = validModels.find(m => m.name.includes("1.5-flash")) || validModels[0];
            if(best) {
                SELECTED_MODEL = best.name.replace("models/", ""); 
                document.getElementById("status").innerText = "‚óè Live";
                addBot(`‚úÖ Connected to Core: ${SELECTED_MODEL}`);
            }
        } catch(e) {
            // Fallback if list fails (common on some keys)
            SELECTED_MODEL = "gemini-1.5-flash";
            document.getElementById("status").innerText = "‚óè Force Live";
        }
    }

    function clearKey() {
        if(confirm("Reset API Key?")) {
            localStorage.removeItem("gemini_key_auto_detect");
            location.reload();
        }
    }

    // --- INTERACTION ---
    function interact(type) {
        const r = document.getElementById("karishma");
        r.style.transform = "translateX(-50%) scale(1.1)";
        setTimeout(() => r.style.transform = "translateX(-50%) scale(1)", 200);
        
        let t = "";
        if(type === 'head') t = "User pets your head. Purr or be cute.";
        if(type === 'tummy') t = "User pokes your tummy. Be ticklish.";
        if(type === 'hand') t = "User holds your hand. Be shy but happy.";
        if(type === 'house') t = "User visits your house. Invite them in.";
        if(type === 'tree') t = "User admires the nature.";
        callAI(t, true);
    }

    // --- CHAT LOGIC ---
    function addBot(t) {
        const d = document.createElement("div"); d.className = "msg b-msg"; d.innerText = t;
        document.getElementById("chat").appendChild(d);
        document.getElementById("chat").scrollTop = document.getElementById("chat").scrollHeight;
    }
    function addUser(t) {
        const d = document.createElement("div"); d.className = "msg u-msg"; d.innerText = t;
        document.getElementById("chat").appendChild(d);
        document.getElementById("chat").scrollTop = document.getElementById("chat").scrollHeight;
    }
    function send() {
        const i = document.getElementById("inp"); const v = i.value.trim();
        if(!v) return; addUser(v); i.value = ""; callAI(v, false);
    }

    async function callAI(text, hidden) {
        if(!SELECTED_MODEL) return;
        const status = document.getElementById("status");
        if(!hidden) status.innerText = "Thinking...";
        
        let context = [...history];
        if(hidden) context.push({role: "user", parts: [{text: `[ACTION]: ${text}`}]});
        else {
            history.push({role: "user", parts: [{text: text}]});
            context = [...history];
        }

        try {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${SELECTED_MODEL}:generateContent?key=${API_KEY}`;
            const res = await fetch(url, {
                method: "POST", headers: {"Content-Type": "application/json"},
                body: JSON.stringify({ contents: [{role: "user", parts: [{text: SYSTEM_PROMPT}]}, ...context] })
            });
            const data = await res.json();
            if (data.candidates) {
                const reply = data.candidates[0].content.parts[0].text;
                if(!hidden) addBot(reply);
                else if(!text.includes("User")) addBot(reply); // Show action replies too
                
                if(!hidden) history.push({role: "model", parts: [{text: reply}]});
                status.innerText = "‚óè Live";
            }
        } catch(e) { status.innerText = "Error"; }
    }
</script>

</body>
</html>
