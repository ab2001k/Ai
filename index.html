<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Karishma: Multi-Model Core</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéÄ</text></svg>">

<style>
    /* ================= CORE VARIABLES ================= */
    :root {
        --sky-day: linear-gradient(180deg, #4facfe, #00f2fe);
        --sky-night: linear-gradient(180deg, #0f0c29, #302b63, #24243e);
        --robot-skin: #fff0f5; 
        --robot-neon: #ff00cc;
        --glass: #f4f7f6;
        --accent: #ff4081;
        --msg-user: linear-gradient(135deg, #ff4081, #d81b60);
        --msg-bot: #ffffff;
    }

    * { box-sizing: border-box; touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
    body { margin: 0; padding: 0; width: 100vw; height: 100vh; height: 100dvh; overflow: hidden; background: #000; font-family: 'Segoe UI', system-ui, sans-serif; display: flex; flex-direction: column; }

    /* ================= LAYOUT ================= */
    #visual-area { 
        flex: 6; position: relative; overflow: hidden; 
        background: var(--sky-day); transition: background 2s ease; 
        width: 100%; z-index: 1;
    }
    #visual-area.night { background: var(--sky-night); }
    
    #chat-area { 
        flex: 4; background: var(--glass); 
        display: flex; flex-direction: column; 
        width: 100%; box-shadow: 0 -10px 30px rgba(0,0,0,0.15); 
        z-index: 100; border-radius: 20px 20px 0 0;
        overflow: hidden;
    }

    @media (min-width: 800px) { 
        body { flex-direction: row; } 
        #visual-area { flex: 6; height: 100%; border-radius: 0; } 
        #chat-area { flex: 4; height: 100%; border-radius: 0; border-left: 2px solid #fff; } 
    }

    /* ================= WORLD OBJECTS ================= */
    .celestial { position: absolute; width: 70px; height: 70px; border-radius: 50%; left: 50%; top: 110%; transition: 1s; z-index: 1; cursor: pointer; }
    #sun { background: radial-gradient(circle, #fff, #ffd700); box-shadow: 0 0 60px 20px rgba(255, 215, 0, 0.6); }
    #moon { background: radial-gradient(#fff, #ccc); box-shadow: 0 0 30px #fff; }

    .mountains { position: absolute; bottom: 25%; width: 100%; z-index: 2; pointer-events: none; }
    .mtn { position: absolute; bottom: 0; width: 0; height: 0; border-left: 120px solid transparent; border-right: 120px solid transparent; border-bottom: 200px solid #2c3e50; } 
    .m1 { left: -50px; bottom: -20px; border-bottom-color: #3f51b5; z-index: 2; }
    .m2 { right: -30px; bottom: -10px; border-width: 0 180px 280px 180px; border-bottom-color: #303f9f; z-index: 1; }

    .ground { position: absolute; bottom: 0; width: 100%; height: 28%; background: linear-gradient(#66bb6a, #2e7d32); z-index: 3; cursor: pointer; }
    
    .road {
        position: absolute; bottom: 0; left: 50%; transform: translateX(-50%);
        width: 120px; height: 28%; background: #555;
        clip-path: polygon(25% 0, 75% 0, 100% 100%, 0% 100%); z-index: 4; cursor: pointer;
    }
    .road::after { content: ''; position: absolute; left: 48%; width: 4%; height: 100%; background: dashed #fff; }

    .pond {
        position: absolute; bottom: 5%; right: 3%; width: 110px; height: 40px;
        background: rgba(33, 150, 243, 0.8); border-radius: 50%;
        border: 2px solid rgba(255,255,255,0.5); z-index: 5;
        box-shadow: inset 0 0 20px rgba(0,0,100,0.2); cursor: pointer;
    }

    .bush { position: absolute; bottom: 15%; width: 40px; height: 30px; background: #1b5e20; border-radius: 50% 50% 0 0; z-index: 5; pointer-events: none; }
    .b1 { left: 15%; } .b2 { right: 25%; } 
    .tree { position: absolute; bottom: 20%; z-index: 5; width: 60px; height: 120px; cursor: pointer; }
    .trunk { width: 10px; height: 40px; background: #5d4037; margin: 80px auto 0; }
    .leaves { width: 60px; height: 90px; background: #2e7d32; border-radius: 50%; position: absolute; top: 0; left: 0; box-shadow: inset -5px -5px 10px rgba(0,0,0,0.2); }

    .css-bird { position: absolute; width: 30px; height: 10px; z-index: 10; animation: flyAcross 25s linear infinite; top: 15%; }
    .wing { width: 15px; height: 8px; position: absolute; top: 0; background: #222; border-radius: 50% 50% 0 0; }
    .wing-l { left: 0; transform-origin: right bottom; animation: flapL 0.3s infinite alternate ease-in-out; }
    .wing-r { right: 0; transform-origin: left bottom; animation: flapR 0.3s infinite alternate ease-in-out; }
    
    @keyframes flyAcross { 0% { left: -10%; transform: translateY(0); } 100% { left: 110%; transform: translateY(-30px); } }
    @keyframes flapL { 0% { transform: rotate(0deg); } 100% { transform: rotate(45deg); } }
    @keyframes flapR { 0% { transform: rotate(0deg); } 100% { transform: rotate(-45deg); } }

    /* ================= ROBOT GIRL ================= */
    .robot {
        position: absolute; bottom: 15%; left: 50%; transform: translateX(-50%);
        z-index: 20; display: flex; flex-direction: column; align-items: center;
        transition: transform 0.2s; filter: drop-shadow(0 5px 15px rgba(255,0,100,0.3));
    }
    .r-head { width: 90px; height: 90px; background: var(--robot-skin); border-radius: 40px 40px 35px 35px; position: relative; z-index: 2; border: 2px solid #ffcae0; cursor: pointer; }
    .r-hair { position: absolute; top: -5px; width: 104%; left: -2%; height: 40px; background: #333; border-radius: 40px 40px 0 0; z-index: 3; }
    .headphone { width: 15px; height: 35px; background: var(--robot-neon); position: absolute; top: 35px; border-radius: 5px; box-shadow: 0 0 10px var(--robot-neon); }
    .hp-l { left: -12px; } .hp-r { right: -12px; }
    .r-eyes { position: absolute; top: 45px; width: 100%; display: flex; justify-content: center; gap: 18px; z-index: 3; }
    .r-eye { width: 18px; height: 26px; background: #222; border-radius: 50%; position: relative; animation: blink 4s infinite; }
    .r-eye::after { content:''; position:absolute; top:5px; right:4px; width:6px; height:6px; background:white; border-radius:50%; }
    .r-body { width: 55px; height: 70px; background: white; margin-top: -10px; border-radius: 15px; border: 2px solid #ddd; position: relative; z-index: 1; display: flex; justify-content: center; align-items: center; cursor: pointer; }
    .r-core { width: 20px; height: 20px; background: var(--robot-neon); border-radius: 50%; box-shadow: 0 0 15px var(--robot-neon); animation: pulse 2s infinite; }
    .r-arm { width: 12px; height: 50px; background: white; border: 2px solid #ddd; border-radius: 10px; position: absolute; top: 25px; cursor: pointer; }
    .arm-l { left: -15px; transform: rotate(15deg); }
    .arm-r { right: -15px; transform: rotate(-15deg); }
    @keyframes blink { 0%,48%,52%,100%{height:26px} 50%{height:2px} }
    @keyframes pulse { 0%{transform:scale(1)} 50%{transform:scale(1.2)} }
    .jump { animation: jumpAnim 0.5s ease 2; }
    @keyframes jumpAnim { 0%,100%{transform:translateX(-50%) translateY(0)} 50%{transform:translateX(-50%) translateY(-20px)} }

    /* ================= CHAT UI ================= */
    .chat-header { padding: 12px 20px; background: #fff; font-weight: bold; font-size: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; }
    .badge { font-size: 10px; padding: 4px 10px; border-radius: 12px; background: #e0f2f1; color: #00695c; cursor: pointer; border: 1px solid #00695c; }
    .chat-history { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; background: #f4f7f6; scroll-behavior: smooth; }
    .msg { padding: 12px 16px; border-radius: 18px; font-size: 15px; max-width: 80%; line-height: 1.4; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: relative; }
    .u-msg { align-self: flex-end; background: var(--msg-user); color: white; border-bottom-right-radius: 4px; }
    .b-msg { align-self: flex-start; background: var(--msg-bot); border: 1px solid #e0e0e0; color: #333; border-bottom-left-radius: 4px; }
    .input-area { padding: 15px; background: #fff; display: flex; gap: 10px; border-top: 1px solid #eee; align-items: center; }
    input { flex: 1; padding: 12px 18px; border-radius: 25px; border: 1px solid #ddd; outline: none; font-size: 16px; background: #f9f9f9; }
    button { width: 45px; height: 45px; border-radius: 50%; border: none; background: var(--accent); color: white; font-size: 18px; cursor: pointer; }
    
    .settings-btn { background: none; color: #555; font-size: 16px; width: auto; height: auto; padding: 0 5px; }

    /* ================= MODALS & OVERLAYS ================= */
    .weather-box { position: absolute; top: 15px; left: 15px; background: rgba(0,0,0,0.6); color: white; padding: 6px 12px; border-radius: 15px; font-size: 11px; z-index: 50; }
    
    #key-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 999; display: flex; justify-content: center; align-items: center; }
    .modal-content { background: white; padding: 25px; border-radius: 15px; width: 90%; max-width: 400px; text-align: center; max-height: 90vh; overflow-y: auto; }
    
    .key-in { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 5px; }
    .btn-main { background: var(--accent); color: white; padding: 10px 20px; border: none; border-radius: 20px; width: 100%; font-weight: bold; margin-top: 10px; cursor: pointer; }
    
    select { width: 100%; padding: 10px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #ccc; background: #fff; font-size: 14px; }
    label { display: block; text-align: left; font-size: 12px; font-weight: bold; color: #555; margin-top: 10px; }
    
    .helper-text { font-size: 11px; color: #666; margin-bottom: 5px; text-align: left; }

</style>
</head>
<body>

<div id="key-modal" style="display:none;">
    <div class="modal-content">
        <h3>üéÄ Karishma Config</h3>
        <p>Select your AI Brain & Enter Key</p>
        
        <label>Select Model:</label>
        <select id="modelSelector" onchange="updateKeyPlaceholder()">
            <optgroup label="Google Gemini (Requires API Key)">
                <option value="gemini-1.5-flash">Gemini 1.5 Flash (Fast)</option>
                <option value="gemini-1.5-pro">Gemini 1.5 Pro (Smart)</option>
                <option value="gemini-1.0-pro">Gemini 1.0 Pro</option>
                <option value="gemini-1.5-flash-8b">Gemini 1.5 Flash-8B</option>
            </optgroup>
            <optgroup label="Hugging Face Free (Requires HF Token)">
                <option value="mistralai/Mistral-7B-Instruct-v0.2">Mistral 7B Instruct</option>
                <option value="google/gemma-7b-it">Gemma 7B IT</option>
                <option value="meta-llama/Meta-Llama-3-8B-Instruct">Llama 3 8B</option>
                <option value="HuggingFaceH4/zephyr-7b-beta">Zephyr 7B Beta</option>
                <option value="tiiuae/falcon-7b-instruct">Falcon 7B</option>
                <option value="microsoft/Phi-3-mini-4k-instruct">Phi-3 Mini</option>
            </optgroup>
             </select>

        <label id="keyLabel">API Key:</label>
        <input type="password" id="apiKeyInput" class="key-in" placeholder="Paste Key Here...">
        
        <p class="helper-text" id="keyHelper">Get Google Key: <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a></p>
        
        <button class="btn-main" onclick="saveSettings()">Connect & Save</button>
        <button class="settings-btn" style="margin-top:10px; font-size:12px;" onclick="document.getElementById('key-modal').style.display='none'">Cancel (if already set)</button>
    </div>
</div>

<div id="visual-area">
    <div class="weather-box" id="weather">üìç Locating...</div>
    
    <div id="sun" class="celestial" onclick="interact('sun')"></div>
    <div id="moon" class="celestial" onclick="interact('moon')"></div>
    
    <div class="mountains"><div class="mtn m1"></div><div class="mtn m2"></div></div>
    <div class="ground" onclick="interact('grass')"></div>
    
    <div class="road" onclick="interact('road')"></div>
    <div class="pond" onclick="interact('pond')"></div>
    
    <div class="bush b1"></div><div class="bush b2"></div>
    <div class="tree" style="left:2%" onclick="interact('tree')"><div class="leaves"></div><div class="trunk"></div></div>
    <div class="tree" style="right:2%" onclick="interact('tree')"><div class="leaves"></div><div class="trunk"></div></div>

    <div class="css-bird" style="top:15%; animation-duration:25s;"><div class="wing wing-l"></div><div class="wing wing-r"></div></div>
    <div class="css-bird" style="top:25%; animation-duration:20s; opacity:0.7"><div class="wing wing-l"></div><div class="wing wing-r"></div></div>

    <div class="robot" id="karishma">
        <div class="r-head" onclick="interact('head')">
            <div class="r-hair"></div>
            <div class="headphone hp-l"></div><div class="headphone hp-r"></div>
            <div class="r-eyes"><div class="r-eye"></div><div class="r-eye"></div></div>
        </div>
        <div class="r-body" onclick="interact('tummy')">
            <div class="r-core"></div>
            <div class="r-arm arm-l" onclick="interact('hand')"></div>
            <div class="r-arm arm-r" onclick="interact('hand')"></div>
        </div>
    </div>
</div>

<div id="chat-area">
    <div class="chat-header">
        <span>Karishma AI</span>
        <div>
            <span class="badge" id="modelDisplay" onclick="openSettings()">Select Model</span>
            <button class="settings-btn" onclick="openSettings()">‚öôÔ∏è</button>
        </div>
    </div>
    <div class="chat-history" id="chat"></div>
    <div class="input-area">
        <input id="inp" placeholder="Type here..." onkeypress="if(event.key==='Enter')send()">
        <button onclick="send()">‚û§</button>
    </div>
</div>

<script>
    // --- 1. CONFIGURATION & STATE ---
    let CURRENT_CONFIG = {
        model: "gemini-1.5-flash",
        provider: "google", // 'google' or 'huggingface'
        key: ""
    };
    
    const SYSTEM_PROMPT = `You are Karishma AI. Creator: Abhik Dutta. 
    Location: Kalain/Silchar area.
    Personality: Cute futuristic robot girl. Sassy, helpful, uses emojis.
    Task: Detect user's language and reply in that language.
    Keep replies short (max 20 words).`;
    
    let history = [];

    // --- 2. STARTUP ---
    window.onload = async () => {
        loadSettings();
        if (!CURRENT_CONFIG.key) {
            openSettings();
        } else {
            addBot(`System Online! üéÄ Using: ${CURRENT_CONFIG.model}`);
            document.getElementById("modelDisplay").innerText = CURRENT_CONFIG.model.split("/").pop(); // Short name
        }
        updateSky();
        fetchWeather();
        setInterval(updateSky, 60000);
    };

    // --- 3. SETTINGS & AUTH ---
    function openSettings() {
        document.getElementById("key-modal").style.display = "flex";
        // Pre-fill if exists
        document.getElementById("modelSelector").value = CURRENT_CONFIG.model;
        updateKeyPlaceholder(); // Set correct label text
    }

    function updateKeyPlaceholder() {
        const sel = document.getElementById("modelSelector");
        const val = sel.value;
        const keyIn = document.getElementById("apiKeyInput");
        const label = document.getElementById("keyLabel");
        const helper = document.getElementById("keyHelper");

        // Simple logic to detect provider based on value prefix or known list
        if (val.startsWith("gemini")) {
            label.innerText = "Google API Key (AIza...):";
            keyIn.placeholder = "AIza...";
            helper.innerHTML = 'Get Key: <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a>';
            // Try to load saved google key
            keyIn.value = localStorage.getItem("karishma_key_google") || "";
        } else {
            label.innerText = "Hugging Face Token (hf_...):";
            keyIn.placeholder = "hf_...";
            helper.innerHTML = 'Get Token: <a href="https://huggingface.co/settings/tokens" target="_blank">Hugging Face Settings</a>';
            // Try to load saved HF key
            keyIn.value = localStorage.getItem("karishma_key_hf") || "";
        }
    }

    function saveSettings() {
        const sel = document.getElementById("modelSelector");
        const keyIn = document.getElementById("apiKeyInput");
        const val = sel.value;
        const key = keyIn.value.trim();

        if (!key) { alert("Please enter a key!"); return; }

        CURRENT_CONFIG.model = val;
        CURRENT_CONFIG.key = key;

        if (val.startsWith("gemini")) {
            CURRENT_CONFIG.provider = "google";
            localStorage.setItem("karishma_key_google", key);
        } else {
            CURRENT_CONFIG.provider = "huggingface";
            localStorage.setItem("karishma_key_hf", key);
        }
        
        localStorage.setItem("karishma_last_model", val);

        document.getElementById("key-modal").style.display = "none";
        document.getElementById("modelDisplay").innerText = val.split("/").pop();
        addBot(`Switched to: ${val} ‚úÖ`);
        history = []; // Clear history on model switch to avoid context format errors
    }

    function loadSettings() {
        const lastModel = localStorage.getItem("karishma_last_model");
        if(lastModel) {
            CURRENT_CONFIG.model = lastModel;
            if(lastModel.startsWith("gemini")) {
                CURRENT_CONFIG.provider = "google";
                CURRENT_CONFIG.key = localStorage.getItem("karishma_key_google");
            } else {
                CURRENT_CONFIG.provider = "huggingface";
                CURRENT_CONFIG.key = localStorage.getItem("karishma_key_hf");
            }
        }
    }

    // --- 4. ENVIRONMENT ---
    function updateSky() {
        const h = new Date().getHours();
        const visual = document.getElementById('visual-area');
        const sun = document.getElementById('sun');
        const moon = document.getElementById('moon');
        if (h >= 6 && h < 18) {
            visual.classList.remove("night");
            let pct = ((h - 6) / 12) * 100;
            sun.style.left = pct + "%"; sun.style.top = (15 + Math.abs(50 - pct)/2) + "%"; moon.style.top = "120%";
        } else {
            visual.classList.add("night");
            let pct = h >= 18 ? ((h-18)/12)*100 : ((h+6)/12)*100;
            moon.style.left = pct + "%"; moon.style.top = (15 + Math.abs(50 - pct)/2) + "%"; sun.style.top = "120%";
        }
    }
    async function fetchWeather() {
        const w = document.getElementById("weather");
        try {
            const res = await fetch("https://api.open-meteo.com/v1/forecast?latitude=24.83&longitude=92.77&current_weather=true");
            const data = await res.json();
            w.innerText = `üìç Kalain: ${data.current_weather.temperature}¬∞C`;
        } catch(e) { w.innerText = "üìç Weather Offline"; }
    }

    // --- 5. INTERACTION ---
    function interact(type) {
        const r = document.getElementById("karishma");
        let prompt = ""; let fallback = "";
        r.classList.add("jump"); setTimeout(() => r.classList.remove("jump"), 500);

        if(type === 'head') { prompt = "User pets your head."; fallback = "Hehe! üòΩ"; }
        else if(type === 'tummy') { prompt = "User taps interface."; fallback = "Tickles! ü§≠"; }
        else if(type === 'hand') { prompt = "User holds hand."; fallback = "Friends! ü§ù"; }
        else if(type === 'pond') { prompt = "User touches water."; fallback = "Splash! üíß"; }
        else if(type === 'grass') { prompt = "User touches grass."; fallback = "Green! üåø"; }
        else if(type === 'road') { prompt = "User on road."; fallback = "Let's go! üö∂‚Äç‚ôÄÔ∏è"; }
        else if(type === 'sun') { prompt = "User points at Sun."; fallback = "Bright! ‚òÄÔ∏è"; }
        else if(type === 'moon') { prompt = "User points at Moon."; fallback = "Sleepy? üåô"; }
        else if(type === 'tree') { prompt = "User touches tree."; fallback = "Nature! üå≥"; }

        callAI(prompt, true, fallback);
    }

    // --- 6. CHAT LOGIC ---
    function addBot(t) {
        const d = document.createElement("div"); d.className = "msg b-msg"; d.innerText = t;
        const c = document.getElementById("chat"); c.appendChild(d); c.scrollTop = c.scrollHeight;
        speak(t);
    }
    function addUser(t) {
        const d = document.createElement("div"); d.className = "msg u-msg"; d.innerText = t;
        const c = document.getElementById("chat"); c.appendChild(d); c.scrollTop = c.scrollHeight;
    }
    function send() {
        const i = document.getElementById("inp"); const v = i.value.trim();
        if(!v) return; addUser(v); i.value = ""; callAI(v, false);
    }

    function speak(text) {
        if (!window.speechSynthesis) return;
        window.speechSynthesis.cancel();
        const cleanText = text.replace(/[\u{1F600}-\u{1F6FF}]/gu, ''); 
        const utterance = new SpeechSynthesisUtterance(cleanText);
        utterance.pitch = 1.3; utterance.rate = 1.1; 
        const voices = window.speechSynthesis.getVoices();
        const femaleVoice = voices.find(v => v.name.includes('Female') || v.name.includes('Google US English'));
        if(femaleVoice) utterance.voice = femaleVoice;
        window.speechSynthesis.speak(utterance);
    }

    // --- 7. UNIFIED AI CALLER ---
    async function callAI(text, hidden, fallback) {
        if(!CURRENT_CONFIG.key) {
            if(!hidden) addBot("‚ö†Ô∏è Setup Key first! (Click Gear ‚öôÔ∏è)");
            return;
        }

        const status = document.getElementById("modelDisplay");
        if(!hidden) status.innerText = "Thinking...";

        try {
            let reply = "";
            
            if (CURRENT_CONFIG.provider === "google") {
                // GOOGLE GEMINI API
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${CURRENT_CONFIG.model}:generateContent?key=${CURRENT_CONFIG.key}`;
                
                // Format history for Gemini
                let geminiHistory = history.map(h => ({
                    role: h.role === "user" ? "user" : "model",
                    parts: [{text: h.text}]
                }));
                geminiHistory.push({role: "user", parts: [{text: text}]});

                const res = await fetch(url, {
                    method: "POST", headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({ 
                        contents: [{role: "user", parts: [{text: SYSTEM_PROMPT}]}, ...geminiHistory]
                    })
                });

                if(res.status !== 200) throw new Error("Gemini API Error: " + res.status);
                const data = await res.json();
                reply = data.candidates[0].content.parts[0].text;

            } else if (CURRENT_CONFIG.provider === "huggingface") {
                // HUGGING FACE INFERENCE API
                const url = `https://api-inference.huggingface.co/models/${CURRENT_CONFIG.model}`;
                
                // Construct simple prompt string for HF (since chat formatting varies)
                // We use a simple instruction format here
                let fullPrompt = `System: ${SYSTEM_PROMPT}\n`;
                history.forEach(h => fullPrompt += `${h.role === 'user' ? 'User' : 'Karishma'}: ${h.text}\n`);
                fullPrompt += `User: ${text}\nKarishma:`;

                const res = await fetch(url, {
                    method: "POST", 
                    headers: {
                        "Authorization": `Bearer ${CURRENT_CONFIG.key}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ 
                        inputs: fullPrompt,
                        parameters: { max_new_tokens: 100, return_full_text: false } 
                    })
                });

                if(res.status !== 200) throw new Error("HF API Error: " + res.status);
                const data = await res.json();
                
                // HF returns array of objects, usually generated_text is inside
                if(Array.isArray(data)) {
                    reply = data[0].generated_text || "No text returned";
                } else if(data.generated_text) {
                    reply = data.generated_text;
                } else {
                    reply = JSON.stringify(data);
                }
            }

            // Common Finalization
            if(!hidden) addBot(reply);
            else if(!text.includes("User")) addBot(reply);

            if(!hidden) {
                history.push({role: "user", text: text});
                history.push({role: "model", text: reply});
                // Keep history small
                if(history.length > 10) history = history.slice(-10);
            }
            status.innerText = CURRENT_CONFIG.model.split("/").pop();

        } catch(e) {
            console.error(e);
            if(fallback) addBot(fallback);
            else addBot(`‚ö†Ô∏è Error: ${e.message}`);
            status.innerText = "Error";
        }
    }
</script>

</body>
</html>
